<header class="fixed-top">
    <!-- === Announcement / Topbar === -->
    <div class="topbar" *ngIf="showTopbar" role="region" aria-label="Aviso superior">
        <div class="container topbar__inner">
            <span class="topbar__msg">
            Cuidarte es un acto de amor. <b>Hazlo hoy. </b>
            <!-- <a routerLink="/nosotros" class="topbar__link"></a>. -->
            <a routerLink="/contacto" class="topbar__link">Conoce más aquí</a>
            </span>

            <!-- <button class="topbar__close" type="button" (click)="dismissTopbar()" aria-label="Cerrar aviso">
            <i class="bi bi-x-lg"></i>
            </button> -->
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-custom" [class.nav-scrolled]="scrolled" (mouseleave)="closeMega()"
        style="padding: 25px;">

        <div class="container position-relative">
            <!-- ===== LADO IZQUIERDO (desktop) ===== -->
            <ul class="navbar-nav d-none d-lg-flex me-auto align-items-lg-center gap-3">
                <li class="nav-item">
                    <a class="nav-link" routerLink="/investigacion">Investigación</a>
                </li>

                <!-- Mega menu -->
                <li class="nav-item dropdown position-static">
                    <button #megaToggle class="nav-link btn btn-link" type="button"
                        [attr.aria-expanded]="megaOpen ? 'true' : 'false'" (click)="toggleMega($event)">
                        Para pacientes
                    </button>

                    <div #megaRef class="mega dropdown-menu border-0 m-0 shadow d-none d-lg-block"
                        [class.show]="megaOpen">
                        <div class="container py-3 py-lg-4">
                            <div class="row g-4 align-items-stretch">
                                <!-- Col 1: Categorías -->
                                <div class="col-12 col-lg-3">
                                    <div class="list-group list-group-flush mega-list">
                                        <button *ngFor="let cat of pacientesCategorias" type="button"
                                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                            [class.active]="cat.key === activeCat?.key" (click)="selectCategory(cat)">
                                            {{ cat.label }} <span class="ms-2" aria-hidden="true">›</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Col 2: Ítems de la categoría seleccionada -->
                                <div class="col-12 col-lg-5">
                                    <div class="list-group list-group-flush mega-list">
                                        <a *ngFor="let it of activeCat?.items"
                                            class="list-group-item list-group-item-action" [routerLink]="it.route"
                                            (click)="gotoItem(it, null)">
                                            {{ it.label }}
                                        </a>
                                        <!-- (mouseenter)="setPreview(it)" (focus)="setPreview(it)" -->
                                    </div>
                                </div>

                                <!-- Col 3: Imagen -->
                                <div class="col-12 col-lg-4">
                                    <div class="ratio ratio-16x9 rounded-3 overflow-hidden bg-light">
                                        <img [src]="currentPreview?.img" [alt]="currentPreview?.alt || activeCat?.label"
                                            class="w-100 h-100 object-fit-cover">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

            <!-- ===== LOGO CENTRADO (desktop) / a la izq en móvil ===== -->
            <a class="navbar-brand brand-center d-flex align-items-center gap-2" routerLink="/" aria-label="Inicio" (click)="toggleCollapse(); toggleCollapse2()">
                <img class="logo logo-light"
                    src="https://s3.us-east-1.amazonaws.com/detecta.pe.files/Logo-Detecta-Color.png" alt="Detecta">
                <img class="logo logo-dark" src="https://s3.us-east-1.amazonaws.com/detecta.pe.files/Logo-Detecta-Color.png"
                    alt="Detecta">
            </a>

            <!-- ===== LADO DERECHO (desktop) ===== -->
            <ul class="navbar-nav d-none d-lg-flex ms-auto align-items-lg-center gap-3">
                <li class="nav-item">
                    <a class="nav-link" routerLink="/nosotros">Sobre Detecta</a>
                </li>
                <li class="nav-item">
                    <a class="btn btn-brand px-3" routerLink="/contacto">Contacto</a>
                </li>
            </ul>

            <!-- ===== TOGGLER (móvil) ===== -->
            <button class="navbar-toggler border-0 shadow-none d-lg-none ms-auto" type="button"
                (click)="toggleCollapse()" [attr.aria-expanded]="!collapsed ? 'true' : 'false'" aria-label="Menú">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- ===== MENÚ MÓVIL (collapse) ===== -->
            <div *ngIf="!isLgUp" class="collapse navbar-collapse" [class.show]="!collapsed">
                <ul class="navbar-nav mt-2">
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/" (click)="toggleCollapse(); toggleCollapse2()">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" routerLink="/investigacion" (click)="toggleCollapse(); toggleCollapse2()">Investigación</a>
                    </li>

                    <!-- PARA PACIENTES - MOBILE -->
                    <li class="nav-item mt-2">
                        <span class="dropdown-header text-uppercase small fw-bold opacity-75">Para pacientes</span>

                        <!-- Acordeón de categorías -->
                        <div class="accordion mt-1" id="pacientesAccordion">
                            <div class="accordion-item" *ngFor="let cat of pacientesCategorias; let i = index">
                                <h2 class="accordion-header" [id]="'acc-h-'+i">
                                    <!-- <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        [attr.data-bs-target]="'#acc-c-'+i" aria-expanded="false"
                                        [attr.aria-controls]="'acc-c-'+i" (click)="selectCategory(cat)">
                                        {{ cat.label }}
                                    </button> -->
                                    <button class="accordion-button collapsed" type="button" (click)="toggleAccordion(i)">
                                        {{ cat.label }}
                                    </button>
                                </h2>
                                
                                <div [ngClass]="{ 'show': isAccordionOpen(i) }" class="accordion-collapse collapse" 
                                    style="height: 320px; overflow: auto;">
                                    <div class="accordion-body p-0">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item px-3 py-2" *ngFor="let it of cat.items">
                                                <a class="nav-link p-0 {{it.class}}" [routerLink]="it.route"
                                                    (pointerdown)="setPreview(it)"
                                                    (click)="gotoItem(it, i); toggleCollapse()">
                                                    {{ it.label }}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- <div class="accordion-collapse collapse" [id]="'acc-c-'+i"
                                    [attr.aria-labelledby]="'acc-h-'+i" data-bs-parent="#pacientesAccordion">
                                    <div class="accordion-body p-0">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item px-3 py-2" *ngFor="let it of cat.items; let i = index">
                                                <a class="nav-link p-0 {{it.class}}" [routerLink]="it.route"
                                                    (pointerdown)="setPreview(it)"
                                                    (click)="gotoItem(it, i); toggleCollapse()">
                                                    {{ it.label }}
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div> -->
                            </div>
                        </div>
                    </li>

                    <li class="nav-item mt-2">
                        <a class="nav-link" routerLink="/nosotros" (click)="toggleCollapse(); toggleCollapse2()">Sobre Detecta</a>
                    </li>
                    <li class="nav-item mt-1">
                        <a class="btn btn-brand w-100" routerLink="/contacto" (click)="toggleCollapse(); toggleCollapse2()">Contacto</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>